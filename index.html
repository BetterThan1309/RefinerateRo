<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RO Refine Simulator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 900px;
            margin: auto;
        }
        h1 {
            color: #0056b3;
            text-align: center;
            margin-bottom: 30px;
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
            align-items: center;
        }
        .controls label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }
        .controls select, .controls input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .current-status {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            padding: 10px;
            background-color: #e0f7fa;
            border-radius: 5px;
            border: 1px solid #b2ebf2;
        }
        .current-status.broken {
            background-color: #ffe0b2;
            border-color: #ffcc80;
            color: darkred;
        }
        .btn-group {
            grid-column: 1 / -1; /* Span all columns */
            text-align: center;
        }
        button {
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            min-width: 120px;
        }
        button.reset-btn {
            background-color: #dc3545;
        }
        button:hover:not(:disabled) {
            opacity: 0.9;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .results {
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            padding: 15px;
            border-radius: 5px;
            min-height: 150px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            font-weight: bold;
        }
        .log-item {
            margin-bottom: 5px;
        }
        .log-success { color: green; }
        .log-fail { color: red; }
        .log-destroy { color: darkred; font-weight: bold; }
        .log-decrease { color: orange; }
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        /* New style for success rate display */
        .success-rate-display {
            font-size: 1.1em;
            font-weight: bold;
            color: #007bff; /* Blue color for emphasis */
            margin-top: 10px;
            text-align: center;
        }
        /* New styles for volume control */
        .volume-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            grid-column: 1 / -1; /* Span all columns */
            justify-content: center;
        }
        .volume-controls button {
            width: 40px;
            height: 40px;
            padding: 0;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .volume-controls input[type="range"] {
            width: 150px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>RO Refine Simulator</h1>

        <div class="current-status">
            ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏µ‡∏ö‡∏ß‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="currentRefineLevelDisplay">+0</span> |
            ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏≠‡πÄ‡∏ó‡∏°: <span id="itemStatusDisplay">‡∏õ‡∏Å‡∏ï‡∏¥</span>
        </div>

        <div class="controls">
            <div>
                <label for="itemType">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏≠‡πÄ‡∏ó‡∏°:</label>
                <select id="itemType">
                    <option value="Weapon">‡∏≠‡∏≤‡∏ß‡∏∏‡∏ò</option>
                    <option value="Armor">‡πÄ‡∏Å‡∏£‡∏≤‡∏∞</option>
                </select>
            </div>
            <div>
                <label for="itemLevel">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÑ‡∏≠‡πÄ‡∏ó‡∏° (Lv):</label>
                <input type="number" id="itemLevel" value="1" min="1" max="5">
            </div>
            <div id="materialSelectContainer">
                <label for="refineMaterial">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏:</label>
                <select id="refineMaterial">
                </select>
            </div>
            <div class="checkbox-container">
                <input type="checkbox" id="useBsb" checked>
                <label for="useBsb">‡πÉ‡∏ä‡πâ Blacksmith Blessing (BSB)</label>
            </div>
            <div class="checkbox-container">
                <input type="checkbox" id="eventRateCheckbox">
                <label for="eventRateCheckbox">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏£‡∏ó‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (Event)</label>
            </div>
            <div class="success-rate-display">
                ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="currentSuccessRateDisplay">N/A</span>
            </div>
            <div class="btn-group">
                <button id="refineOnceBtn">‡∏ï‡∏µ‡∏ö‡∏ß‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</button>
                <button id="resetItemBtn" class="reset-btn">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏≠‡πÄ‡∏ó‡∏°</button>
            </div>

            <div class="volume-controls">
                <button id="muteToggleBtn" aria-label="‡∏õ‡∏¥‡∏î/‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á">üîá</button>
                <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.5" aria-label="‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á">
            </div>
            </div>

        <h2>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á:</h2>
        <div id="resultsLog" class="results">
        </div>

        <div id="summary" class="summary">
            <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</h3>
            <ul id="materialSummary">
            </ul>
            <p>‡∏£‡∏ß‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°: <span id="totalAttempts">0</span> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
        </div>
    </div>

    <audio id="successSound" src="success.mp3" preload="auto"></audio>
    <audio id="failSound" src="fail.mp3" preload="auto"></audio>

    <script>
        // 1. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        // ‡πÅ‡∏ï‡πà‡∏•‡∏∞ itemKey (‡πÄ‡∏ä‡πà‡∏ô "Weapon_1") ‡∏°‡∏µ sub-object "normal" ‡πÅ‡∏•‡∏∞ "cash"
        // ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô "normal" ‡∏´‡∏£‡∏∑‡∏≠ "cash" ‡∏à‡∏∞‡∏°‡∏µ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏ô‡∏¥‡∏î
        const SUCCESS_RATES = {
            "Armor_1": {
                "normal": { // ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û)
                    "Elunium": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 80, 5: 60, 6: 60, 7: 40, 8: 40, 9: 20, 10: 20 },
                    "Carnium": { 11: 16, 12: 16, 13: 16, 14: 15, 15: 15, 16: 14, 17: 14, 18: 14, 19: 10 },
                    // Enriched Elunium, HD Elunium, HD Carnium ‡πÑ‡∏°‡πà‡∏°‡∏µ rate_group "normal" ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤
                    // ‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏ó‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Elunium/Carnium ‡πÉ‡∏ô normal mode ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞ (‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏°‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà)
                    "Enriched Elunium": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 80, 5: 60, 6: 60, 7: 40, 8: 40, 9: 20, 10: 20 }, // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡πÄ‡∏£‡∏ó‡πÄ‡∏ó‡πà‡∏≤ Elunium
                    "HD Elunium": { 7: 40, 8: 40, 9: 20, 10: 20 }, // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡πÄ‡∏£‡∏ó‡πÄ‡∏ó‡πà‡∏≤ Elunium ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 7-10
                    "HD Carnium": { 11: 16, 12: 16, 13: 16, 14: 15, 15: 15, 16: 14, 17: 14, 18: 14, 19: 10 }, // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡πÄ‡∏£‡∏ó‡πÄ‡∏ó‡πà‡∏≤ Carnium
                },
                "cash": { // ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û)
                    "Elunium": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 100, 5: 95, 6: 85, 7: 70, 8: 70, 9: 55, 10: 45 },
                    "Carnium": { 11: 35, 12: 35, 13: 30, 14: 30, 15: 30, 16: 20, 17: 20, 18: 20, 19: 10 },
                    "Enriched Elunium": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 100, 5: 95, 6: 85, 7: 70, 8: 70, 9: 55, 10: 45 },
                    "HD Elunium": { 7: 70, 8: 70, 9: 55, 10: 45 }, // HD Elunium ‡∏°‡∏µ‡πÄ‡∏£‡∏ó‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà +7 (‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡∏ó Elunium cash)
                    "HD Carnium": { 11: 35, 12: 35, 13: 30, 14: 30, 15: 30, 16: 20, 17: 20, 18: 20, 19: 10 }, // HD Carnium (‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡∏ó Carnium cash)
                }
            },
            "Armor_2": { // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤ ‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏ó‡πÄ‡∏î‡∏¥‡∏°
                "normal": {
                    "Etherium": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 80, 5: 60, 6: 60, 7: 40, 8: 40, 9: 20, 10: 20 },
                    "Etel Carnium": { 11: 16, 12: 16, 13: 16, 14: 15, 15: 15, 16: 14, 17: 14, 18: 14, 19: 10 },
                    "Enriched Etherium": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 80, 5: 60, 6: 60, 7: 40, 8: 40, 9: 20, 10: 20 },
                    "HD Etherium": { 11: 16, 12: 16, 13: 16, 14: 15 },
                    "HD Etel Carnium": { 15: 14, 16: 14, 17: 14, 18: 14, 19: 10 },
                },
                "cash": {
                    "Etherium": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 100, 5: 95, 6: 85, 7: 70, 8: 70, 9: 55, 10: 45 },
                    "Etel Carnium": { 11: 35, 12: 35, 13: 30, 14: 30, 15: 30, 16: 20, 17: 20, 18: 20, 19: 10 },
                    "Enriched Etherium": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 100, 5: 95, 6: 85, 7: 70, 8: 70, 9: 55, 10: 45 },
                    "HD Etherium": { 11: 35, 12: 35, 13: 30, 14: 30 },
                    "HD Etel Carnium": { 15: 30, 16: 20, 17: 20, 18: 20, 19: 10 },
                }
            },
            "Weapon_1": {
                "normal": { // ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û)
                    "Phracon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 80, 5: 60, 6: 60, 7: 40, 8: 40, 9: 20, 10: 20 },
                    "Bradium": { 11: 16, 12: 16, 13: 16, 14: 15, 15: 15, 16: 14, 17: 14, 18: 14, 19: 10 },
                    // Enriched Phracon ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å
                },
                "cash": { // ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û)
                    "Phracon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 100, 5: 95, 6: 85, 7: 70, 8: 70, 9: 55, 10: 45 },
                    "Bradium": { 11: 35, 12: 35, 13: 30, 14: 30, 15: 30, 16: 20, 17: 20, 18: 20, 19: 10 },
                    // Enriched Phracon ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å
                }
            },
            "Weapon_2": {
                "normal": { // ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û)
                    "Emveretarcon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 80, 5: 60, 6: 60, 7: 40, 8: 40, 9: 20, 10: 20 },
                    "Bradium": { 11: 16, 12: 16, 13: 16, 14: 15, 15: 15, 16: 14, 17: 14, 18: 14, 19: 10 },
                    // Enriched Emveretarcon ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å
                },
                "cash": { // ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û)
                    "Emveretarcon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 100, 5: 95, 6: 85, 7: 70, 8: 70, 9: 55, 10: 45 },
                    "Bradium": { 11: 35, 12: 35, 13: 30, 14: 30, 15: 30, 16: 20, 17: 20, 18: 20, 19: 10 },
                    // Enriched Emveretarcon ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å
                }
            },
            "Weapon_3": {
                "normal": { // ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û)
                    "Oridecon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 80, 5: 60, 6: 60, 7: 40, 8: 40, 9: 20, 10: 20 },
                    "Bradium": { 11: 16, 12: 16, 13: 16, 14: 15, 15: 15, 16: 14, 17: 14, 18: 14, 19: 10 },
                    "Enriched Oridecon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 80, 5: 60, 6: 60, 7: 40, 8: 40, 9: 20, 10: 20 }, // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡πÄ‡∏£‡∏ó‡πÄ‡∏ó‡πà‡∏≤ Oridecon
                    "HD Oridecon": { 7: 40, 8: 40, 9: 20, 10: 20 }, // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡πÄ‡∏£‡∏ó‡πÄ‡∏ó‡πà‡∏≤ Oridecon ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 7-10
                },
                "cash": { // ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û)
                    "Oridecon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 100, 5: 95, 6: 85, 7: 70, 8: 70, 9: 55, 10: 45 },
                    "Bradium": { 11: 35, 12: 35, 13: 30, 14: 30, 15: 30, 16: 20, 17: 20, 18: 20, 19: 10 },
                    "Enriched Oridecon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 100, 5: 95, 6: 85, 7: 70, 8: 70, 9: 55, 10: 45 },
                    "HD Oridecon": { 7: 70, 8: 70, 9: 55, 10: 45 }, // HD Oridecon 7-10 (‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡∏ó Oridecon cash)
                }
            },
            "Weapon_4": { // Same as Weapon_3
                "normal": { // ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û)
                    "Oridecon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 80, 5: 60, 6: 60, 7: 40, 8: 40, 9: 20, 10: 20 },
                    "Bradium": { 11: 16, 12: 16, 13: 16, 14: 15, 15: 15, 16: 14, 17: 14, 18: 14, 19: 10 },
                    "Enriched Oridecon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 80, 5: 60, 6: 60, 7: 40, 8: 40, 9: 20, 10: 20 },
                    "HD Oridecon": { 7: 40, 8: 40, 9: 20, 10: 20 },
                },
                "cash": { // ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û)
                    "Oridecon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 100, 5: 95, 6: 85, 7: 70, 8: 70, 9: 55, 10: 45 },
                    "Bradium": { 11: 35, 12: 35, 13: 30, 14: 30, 15: 30, 16: 20, 17: 20, 18: 20, 19: 10 },
                    "Enriched Oridecon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 100, 5: 95, 6: 85, 7: 70, 8: 70, 9: 55, 10: 45 },
                    "HD Oridecon": { 7: 70, 8: 70, 9: 55, 10: 45 },
                }
            },
            "Weapon_5": { // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤ ‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏ó‡πÄ‡∏î‡∏¥‡∏°
                "normal": {
                    "Etherdeocon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 80, 5: 60, 6: 60, 7: 40, 8: 40, 9: 20, 10: 20 },
                    "Etel Bradium": { 11: 16, 12: 16, 13: 16, 14: 15, 15: 15, 16: 14, 17: 14, 18: 14, 19: 10 },
                    "Enriched Etherdeocon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 80, 5: 60, 6: 60, 7: 40, 8: 40, 9: 20, 10: 20 },
                    "HD Etherdeocon": { 11: 16, 12: 16, 13: 16, 14: 15 },
                    "HD Etel Bradium": { 11: 16, 12: 16, 13: 16, 14: 15 },
                },
                "cash": {
                    "Etherdeocon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 95, 5: 85, 6: 85, 7: 70, 8: 70, 9: 55, 10: 45 },
                    "Etel Bradium": { 11: 35, 12: 35, 13: 30, 14: 30, 15: 30, 16: 20, 17: 20, 18: 20, 19: 10 },
                    "Enriched Etherdeocon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 95, 5: 85, 6: 85, 7: 70, 8: 70, 9: 55, 10: 45 },
                    "HD Etherdeocon": { 11: 35, 12: 35, 13: 30, 14: 30 },
                    "HD Etel Bradium": { 11: 35, 12: 35, 13: 30, 14: 30 },
                }
            }
        };

        // 2. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡∏ï‡∏µ‡∏ö‡∏ß‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ
        // ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏£‡∏ß‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏•‡∏¥‡∏™‡∏ï‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÅ‡∏•‡∏∞ fail_effect
        const REFINE_MATERIALS = {
            "Weapon": {
                1: [
                    { material_id: "Phracon", name: "Phracon", fail_effect: "destroy", range: [0, 10] },
                    { material_id: "Bradium", name: "Bradium", fail_effect: "destroy", range: [11, 19] },
                    // Enriched Phracon ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å
                ],
                2: [
                    { material_id: "Emveretarcon", name: "Emveretarcon", fail_effect: "destroy", range: [0, 10] },
                    { material_id: "Bradium", name: "Bradium", fail_effect: "destroy", range: [11, 19] },
                    // Enriched Emveretarcon ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å
                ],
                3: [
                    { material_id: "Oridecon", name: "Oridecon", fail_effect: "destroy", range: [0, 10] },
                    { material_id: "Bradium", name: "Bradium", fail_effect: "destroy", range: [11, 19] },
                    { material_id: "Enriched Oridecon", name: "Enriched Oridecon", fail_effect: "destroy", range: [0, 10] },
                    { material_id: "HD Oridecon", name: "HD Oridecon", fail_effect: "decrease_1", range: [7, 10] },
                ],
                4: [ // Same as Lv.3
                    { material_id: "Oridecon", name: "Oridecon", fail_effect: "destroy", range: [0, 10] },
                    { material_id: "Bradium", name: "Bradium", fail_effect: "destroy", range: [11, 19] },
                    { material_id: "Enriched Oridecon", name: "Enriched Oridecon", fail_effect: "destroy", range: [0, 10] },
                    { material_id: "HD Oridecon", name: "HD Oridecon", fail_effect: "decrease_1", range: [7, 10] },
                ],
                5: [
                    { material_id: "Etherdeocon", name: "Etherdeocon", fail_effect: "decrease_3", range: [0, 10] },
                    { material_id: "Etel Bradium", name: "Etel Bradium", fail_effect: "destroy", range: [11, 19] },
                    { material_id: "Enriched Etherdeocon", name: "Enriched Etherdeocon", fail_effect: "decrease_1", range: [0, 10] },
                    { material_id: "HD Etherdeocon", name: "HD Etherdeocon", fail_effect: "destroy", range: [11, 14] },
                    { material_id: "HD Etel Bradium", name: "HD Etel Bradium", fail_effect: "destroy", range: [11, 14] },
                ]
            },
            "Armor": {
                1: [
                    { material_id: "Elunium", name: "Elunium", fail_effect: "destroy", range: [0, 10] },
                    { material_id: "Carnium", name: "Carnium", fail_effect: "destroy", range: [11, 19] },
                    { material_id: "Enriched Elunium", name: "Enriched Elunium", fail_effect: "destroy", range: [0, 10] },
                    { material_id: "HD Elunium", name: "HD Elunium", fail_effect: "decrease_1", range: [7, 10] },
                    { material_id: "HD Carnium", name: "HD Carnium", fail_effect: "destroy", range: [11, 19] },
                ],
                2: [
                    { material_id: "Etherium", name: "Etherium", fail_effect: "decrease_3", range: [0, 10] },
                    { material_id: "Etel Carnium", name: "Etel Carnium", fail_effect: "destroy", range: [11, 19] },
                    { material_id: "Enriched Etherium", name: "Enriched Etherium", fail_effect: "decrease_1", range: [0, 10] },
                    { material_id: "HD Etherium", name: "HD Etherium", fail_effect: "destroy", range: [11, 14] },
                    { material_id: "HD Etel Carnium", name: "HD Etel Carnium", fail_effect: "destroy", range: [15, 19] },
                ]
            }
        };

        // 3. Blacksmith Blessing (BSB) Costs
        const BSB_COSTS = {
            "normal": { // ‡∏ä‡πà‡∏ß‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
                7: 1, 
                8: 2, 
                9: 4, 
                10: 7,
                11: 11,
                12: 16,
                13: 22,
            },
            "cash": { // ‡∏ä‡πà‡∏ß‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
                7: 1,
                8: 2,
                9: 3, 
                10: 4,
                11: 7, 
                12: 11,
                13: 16,
            }
        };

        // UI Elements
        const itemTypeSelect = document.getElementById('itemType');
        const itemLevelInput = document.getElementById('itemLevel');
        const refineMaterialSelect = document.getElementById('refineMaterial');
        const useBsbCheckbox = document.getElementById('useBsb');
        const eventRateCheckbox = document.getElementById('eventRateCheckbox'); // Checkbox for event rate
        const refineOnceBtn = document.getElementById('refineOnceBtn');
        const resetItemBtn = document.getElementById('resetItemBtn');
        const resultsLog = document.getElementById('resultsLog');
        const currentRefineLevelDisplay = document.getElementById('currentRefineLevelDisplay');
        const itemStatusDisplay = document.getElementById('itemStatusDisplay');
        const totalAttemptsSpan = document.getElementById('totalAttempts');
        const materialSummaryList = document.getElementById('materialSummary');
        const currentStatusContainer = document.querySelector('.current-status');
        const currentSuccessRateDisplay = document.getElementById('currentSuccessRateDisplay');

        // Audio Elements
        const successSound = document.getElementById('successSound');
        const failSound = document.getElementById('failSound');

        // New: Volume Control Elements
        const muteToggleBtn = document.getElementById('muteToggleBtn');
        const volumeSlider = document.getElementById('volumeSlider');

        let currentRefineLevel = 0;
        let itemBroken = false;
        let totalAttempts = 0;
        let materialsUsed = {}; // Dictionary to store material counts
        let isMuted = false; // New: Mute state

        // Helper function for random number (similar to Python's random.random())
        const random = {
            random: function() {
                return Math.random();
            }
        };

        // --- Functions to manage UI and game state ---

        // New function to play sound
        function playSound(type) {
            if (isMuted) {
                return; // Don't play if muted
            }

            const soundElement = type === 'success' ? successSound : failSound;
            soundElement.currentTime = 0; // Rewind to start if already playing
            soundElement.play();
        }

        function logResult(message, type = "") {
            const p = document.createElement('p');
            p.textContent = message;
            p.classList.add('log-item');
            if (type) {
                p.classList.add(`log-${type}`);
            }
            resultsLog.prepend(p); // Add to top for easier viewing of latest
            // Keep only last 100 logs to prevent performance issues
            while (resultsLog.children.length > 100) {
                resultsLog.removeChild(resultsLog.lastChild);
            }
        }

        function updateMaterialSummary() {
            materialSummaryList.innerHTML = '';
            // Sort materials by name for consistent display
            const sortedMaterials = Object.keys(materialsUsed).sort();
            for (const material of sortedMaterials) {
                if (materialsUsed[material] > 0) {
                    const li = document.createElement('li');
                    li.textContent = `${material}: ${materialsUsed[material]} ‡∏ä‡∏¥‡πâ‡∏ô`;
                    materialSummaryList.appendChild(li);
                }
            }
        }

        function getCalculatedSuccessRate() {
            const itemType = itemTypeSelect.value;
            const itemLevel = parseInt(itemLevelInput.value);
            const selectedMaterialValue = refineMaterialSelect.value;
            const useEventRate = eventRateCheckbox.checked; // Get state of event rate checkbox

            if (!selectedMaterialValue) {
                return "N/A"; // No material selected
            }

            // materialDisplayName is now stored directly as the value
            const [materialId, failEffectRaw, materialDisplayName, materialRangeStart, materialRangeEnd] = selectedMaterialValue.split('|');
            
            const refineLevelToAttempt = currentRefineLevel;
            const itemKey = `${itemType}_${itemLevel}`;
            
            // Determine which rate set to use based on eventRateCheckbox
            const rateSet = useEventRate ? "cash" : "normal";
            
            // Get the success rate for the specific material and refine level from the chosen rateSet
            const ratesForMaterial = SUCCESS_RATES[itemKey]?.[rateSet]?.[materialId];
            const successRate = ratesForMaterial ? ratesForMaterial[refineLevelToAttempt] : undefined;
            
            return successRate !== undefined ? `${successRate}%` : "N/A";
        }

        function updateCurrentItemStatus() {
            currentRefineLevelDisplay.textContent = `+${currentRefineLevel}`;
            if (itemBroken) {
                itemStatusDisplay.textContent = '‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢!';
                currentStatusContainer.classList.add('broken');
                refineOnceBtn.disabled = true; // Disable refine if broken
                refineMaterialSelect.disabled = true;
                useBsbCheckbox.disabled = true;
                eventRateCheckbox.disabled = true; // Disable event rate checkbox if broken
            } else {
                itemStatusDisplay.textContent = '‡∏õ‡∏Å‡∏ï‡∏¥';
                currentStatusContainer.classList.remove('broken');
                refineOnceBtn.disabled = false;
                refineMaterialSelect.disabled = false;
                // --- Start: BSB Checkbox specific logic ---
                // Disable BSB checkbox if currentRefineLevel is less than 7
                useBsbCheckbox.disabled = (currentRefineLevel < 7);
                // If BSB checkbox is disabled, uncheck it to prevent accidental use
                if (useBsbCheckbox.disabled) {
                    useBsbCheckbox.checked = false;
                }
                // --- End: BSB Checkbox specific logic ---
                eventRateCheckbox.disabled = false; // Enable event rate checkbox if not broken
            }
            totalAttemptsSpan.textContent = totalAttempts;
            updateMaterialSummary();
            updateMaterialOptions(true); // Call with true to try and preserve selection
            currentSuccessRateDisplay.textContent = getCalculatedSuccessRate(); // Update success rate display
        }

        function updateMaterialOptions(preserveSelection = false) {
            const itemType = itemTypeSelect.value;
            const itemLevel = parseInt(itemLevelInput.value);
            const useEventRate = eventRateCheckbox.checked;
            const itemKey = `${itemType}_${itemLevel}`;
            
            const availableMaterials = REFINE_MATERIALS[itemType] ? REFINE_MATERIALS[itemType][itemLevel] : [];
            const previousSelection = refineMaterialSelect.value; // Store previous selection
            
            refineMaterialSelect.innerHTML = ''; // Clear previous options

            if (itemBroken) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢ (‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)';
                refineMaterialSelect.appendChild(option);
                refineOnceBtn.disabled = true;
                currentSuccessRateDisplay.textContent = "N/A";
                return;
            }

            if (availableMaterials.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡∏µ‡πâ';
                refineMaterialSelect.appendChild(option);
                refineOnceBtn.disabled = true;
                currentSuccessRateDisplay.textContent = "N/A";
                return;
            }
            
            refineOnceBtn.disabled = false;

            let hasValidMaterial = false;
            let foundPreviousSelection = false;
            let firstValidMaterialValue = '';

            // Populate select with available materials that are valid for current refine level
            availableMaterials.forEach(material => {
                const materialId = material.material_id;
                const materialDisplayName = material.name;
                const failEffect = material.fail_effect;
                const rangeStart = material.range[0];
                const rangeEnd = material.range[1];

                // Check if the current refine level is within the material's valid range
                if (currentRefineLevel >= rangeStart && currentRefineLevel <= rangeEnd) {
                    const rateSet = useEventRate ? "cash" : "normal";
                    const successRate = SUCCESS_RATES[itemKey]?.[rateSet]?.[materialId]?.[currentRefineLevel];
                    
                    if (successRate !== undefined) { // Only show materials with a defined rate for current level and selected rateSet
                        const option = document.createElement('option');
                        // Store material_id, fail_effect, name, range_start, range_end in value for easy retrieval
                        const optionValue = `${materialId}|${failEffect}|${materialDisplayName}|${rangeStart}|${rangeEnd}`;
                        option.value = optionValue;
                        option.textContent = `${materialDisplayName} (‡πÄ‡∏£‡∏ó ${successRate}%)`; // Display rate in option
                        refineMaterialSelect.appendChild(option);
                        hasValidMaterial = true;

                        if (preserveSelection && optionValue === previousSelection) {
                            foundPreviousSelection = true;
                            option.selected = true;
                        }

                        if (!firstValidMaterialValue) {
                            firstValidMaterialValue = optionValue;
                        }
                    }
                }
            });

            // If no valid materials for current level and rate set, disable button and clear rate
            if (!hasValidMaterial) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡∏µ‡πâ';
                refineMaterialSelect.appendChild(option);
                refineOnceBtn.disabled = true;
                currentSuccessRateDisplay.textContent = "N/A";
            } else {
                if (preserveSelection && foundPreviousSelection) {
                    // Already selected
                } else if (firstValidMaterialValue) {
                    refineMaterialSelect.value = firstValidMaterialValue; // Select the first valid option
                }
            }
            currentSuccessRateDisplay.textContent = getCalculatedSuccessRate();
        }

        function refineItem() {
            if (itemBroken) {
                logResult("‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà.", "fail");
                return;
            }

            const itemType = itemTypeSelect.value;
            const itemLevel = parseInt(itemLevelInput.value);
            const selectedMaterialValue = refineMaterialSelect.value;
            const useBsb = useBsbCheckbox.checked;
            const useEventRate = eventRateCheckbox.checked; // Get state of event rate checkbox

            if (!selectedMaterialValue) {
                logResult("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏µ‡∏ö‡∏ß‡∏Å.", "fail");
                return;
            }

            const [materialId, failEffectRaw, materialDisplayName, materialRangeStart, materialRangeEnd] = selectedMaterialValue.split('|');
            
            const refineLevelToAttempt = currentRefineLevel;
            const itemKey = `${itemType}_${itemLevel}`;
            
            // Determine which rate set to use based on eventRateCheckbox
            const rateSet = useEventRate ? "cash" : "normal";
            const successRate = SUCCESS_RATES[itemKey]?.[rateSet]?.[materialId]?.[refineLevelToAttempt];

            if (successRate === undefined) {
                logResult(`Error: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${materialDisplayName} ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö +${refineLevelToAttempt} ‡πÉ‡∏ô‡πÄ‡∏£‡∏ó ${rateSet}. ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•.`, "fail");
                return;
            }
            
            // Check if selected material is valid for the current refine level before proceeding
            if (refineLevelToAttempt < parseInt(materialRangeStart) || refineLevelToAttempt > parseInt(materialRangeEnd)) {
                logResult(`Error: ‡∏ß‡∏±‡∏™‡∏î‡∏∏ ${materialDisplayName} ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ï‡∏µ‡∏ö‡∏ß‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö +${refineLevelToAttempt} ‡πÑ‡∏î‡πâ. ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏≠ +${materialRangeStart} ‡∏ñ‡∏∂‡∏á +${materialRangeEnd}.`, "fail");
                return;
            }

            // Track material usage
            materialsUsed[materialDisplayName] = (materialsUsed[materialDisplayName] || 0) + 1;
            totalAttempts++;

            let bsbUsed = 0;
            // Use selected rate group (normal/cash) to get BSB cost
            const bsbCost = BSB_COSTS[rateSet] ? BSB_COSTS[rateSet][refineLevelToAttempt] : 0;

            if (useBsb && bsbCost > 0) {
                bsbUsed = bsbCost;
                materialsUsed["Blacksmith Blessing"] = (materialsUsed["Blacksmith Blessing"] || 0) + bsbUsed;
                logResult(`‡πÉ‡∏ä‡πâ Blacksmith Blessing ${bsbUsed} ‡∏ä‡∏¥‡πâ‡∏ô`);
            } else if (useBsb && bsbCost === 0 && refineLevelToAttempt >=7 && refineLevelToAttempt <= 13) {
                logResult(`Warning: Blacksmith Blessing ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö +${refineLevelToAttempt} ‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏£‡∏ó ${rateSet} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•.`, "fail");
            }

            const rand = random.random() * 100; // Generate a random number between 0 and 99.99...

            logResult(`‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ï‡∏µ‡∏ö‡∏ß‡∏Å ${itemType} Lv.${itemLevel} ‡∏à‡∏≤‡∏Å +${refineLevelToAttempt} ‡πÄ‡∏õ‡πá‡∏ô +${refineLevelToAttempt + 1} (‡πÉ‡∏ä‡πâ ${materialDisplayName}, ‡πÄ‡∏£‡∏ó: ${rateSet === 'cash' ? '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°' : '‡∏õ‡∏Å‡∏ï‡∏¥'}) - ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${successRate}%`);

            if (rand < successRate) {
                currentRefineLevel++;
                logResult(`‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô +${currentRefineLevel}`, "success");
                playSound('success');
            } else {
                logResult(`‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß! ‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏õ‡πá‡∏ô +${currentRefineLevel}`, "fail");
                playSound('fail');

                // Determine fail effect based on material
                switch (failEffectRaw) {
                    case "destroy":
                        itemBroken = true;
                        logResult("‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ó‡∏≥‡∏•‡∏≤‡∏¢!", "destroy");
                        break;
                    case "decrease_1":
                        currentRefineLevel = Math.max(0, currentRefineLevel - 1);
                        logResult(`‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏µ‡∏ö‡∏ß‡∏Å‡∏•‡∏î‡∏•‡∏á 1 ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ +${currentRefineLevel}`, "decrease");
                        break;
                    case "decrease_3":
                        currentRefineLevel = Math.max(0, currentRefineLevel - 3);
                        logResult(`‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏µ‡∏ö‡∏ß‡∏Å‡∏•‡∏î‡∏•‡∏á 3 ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ +${currentRefineLevel}`, "decrease");
                        break;
                    default:
                        // No specific fail effect, item just stays the same level on fail
                        break;
                }
            }
            updateCurrentItemStatus();
        }

        function resetItem() {
            currentRefineLevel = 0;
            itemBroken = false;
            totalAttempts = 0;
            materialsUsed = {};
            resultsLog.innerHTML = ''; // Clear log
            updateCurrentItemStatus();
            logResult("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà.", "reset");
        }

        // --- New: Volume Control Functions ---
        function toggleMute() {
            isMuted = !isMuted;
            successSound.muted = isMuted;
            failSound.muted = isMuted;
            muteToggleBtn.textContent = isMuted ? 'üîá' : 'üîä';
            // Disable slider if muted, enable if unmuted
            volumeSlider.disabled = isMuted; 
            // If unmuting, restore previous volume or default
            if (!isMuted) {
                // Set volume to slider value if unmuted
                setVolume(parseFloat(volumeSlider.value)); 
            } else {
                // If muted, set volume to 0 (visually and audibly)
                successSound.volume = 0;
                failSound.volume = 0;
            }
        }

        function setVolume(volume) {
            successSound.volume = volume;
            failSound.volume = volume;
            // Ensure mute button icon reflects volume if volume slider is used
            if (volume === 0 && !isMuted) {
                muteToggleBtn.textContent = 'üîá';
                isMuted = true;
            } else if (volume > 0 && isMuted) {
                muteToggleBtn.textContent = 'üîä';
                isMuted = false;
            }
        }
        // --- End New: Volume Control Functions ---


        // --- Event Listeners ---
        itemTypeSelect.addEventListener('change', updateCurrentItemStatus);
        itemLevelInput.addEventListener('change', updateCurrentItemStatus);
        eventRateCheckbox.addEventListener('change', updateCurrentItemStatus); // Listen for event rate changes
        refineMaterialSelect.addEventListener('change', () => {
            currentSuccessRateDisplay.textContent = getCalculatedSuccessRate(); // Update rate when material changes
        });
        refineOnceBtn.addEventListener('click', refineItem);
        resetItemBtn.addEventListener('click', resetItem);

        // New: Volume Control Event Listeners
        muteToggleBtn.addEventListener('click', toggleMute);
        volumeSlider.addEventListener('input', (event) => {
            setVolume(parseFloat(event.target.value));
        });

        // Initial setup
        updateCurrentItemStatus();
        // Set initial volume for audio elements based on slider
        setVolume(parseFloat(volumeSlider.value));

    </script>
</body>
</html>