<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RO Refine Simulator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 900px;
            margin: auto;
        }
        h1 {
            color: #0056b3;
            text-align: center;
            margin-bottom: 30px;
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
            align-items: center;
        }
        .controls label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }
        .controls select, .controls input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .current-status {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            padding: 10px;
            background-color: #e0f7fa;
            border-radius: 5px;
            border: 1px solid #b2ebf2;
        }
        .current-status.broken {
            background-color: #ffe0b2;
            border-color: #ffcc80;
            color: darkred;
        }
        .btn-group {
            grid-column: 1 / -1; /* Span all columns */
            text-align: center;
        }
        button {
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            min-width: 120px;
        }
        button.reset-btn {
            background-color: #dc3545;
        }
        button:hover:not(:disabled) {
            opacity: 0.9;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .results {
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            padding: 15px;
            border-radius: 5px;
            min-height: 150px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            font-weight: bold;
        }
        .log-item {
            margin-bottom: 5px;
        }
        .log-success { color: green; }
        .log-fail { color: red; }
        .log-destroy { color: darkred; font-weight: bold; }
        .log-decrease { color: orange; }
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        /* New style for success rate display */
        .success-rate-display {
            font-size: 1.1em;
            font-weight: bold;
            color: #007bff; /* Blue color for emphasis */
            margin-top: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>RO Refine Simulator</h1>

        <div class="current-status">
            ระดับตีบวกปัจจุบัน: <span id="currentRefineLevelDisplay">+0</span> |
            สถานะไอเทม: <span id="itemStatusDisplay">ปกติ</span>
        </div>

        <div class="controls">
            <div>
                <label for="itemType">ประเภทไอเทม:</label>
                <select id="itemType">
                    <option value="Weapon">อาวุธ</option>
                    <option value="Armor">เกราะ</option>
                </select>
            </div>
            <div>
                <label for="itemLevel">ระดับไอเทม (Lv):</label>
                <input type="number" id="itemLevel" value="1" min="1" max="5">
            </div>
            <div id="materialSelectContainer">
                <label for="refineMaterial">เลือกวัสดุ:</label>
                <select id="refineMaterial">
                </select>
            </div>
            <div class="checkbox-container">
                <input type="checkbox" id="useBsb" checked>
                <label for="useBsb">ใช้ Blacksmith Blessing (BSB)</label>
            </div>
            <div class="checkbox-container">
                <input type="checkbox" id="eventRateCheckbox">
                <label for="eventRateCheckbox">ช่วงเรทกิจกรรม (Event)</label>
            </div>
            <div class="success-rate-display">
                อัตราสำเร็จปัจจุบัน: <span id="currentSuccessRateDisplay">N/A</span>
            </div>
            <div class="btn-group">
                <button id="refineOnceBtn">ตีบวกครั้งเดียว</button>
                <button id="resetItemBtn" class="reset-btn">รีเซ็ตไอเทม</button>
            </div>
        </div>

        <h2>ผลลัพธ์การจำลอง:</h2>
        <div id="resultsLog" class="results">
        </div>

        <div id="summary" class="summary">
            <h3>สรุปวัสดุที่ใช้ทั้งหมด:</h3>
            <ul id="materialSummary">
            </ul>
            <p>รวมจำนวนครั้งที่พยายาม: <span id="totalAttempts">0</span> ครั้ง</p>
        </div>
    </div>

    <script>
        // 1. กำหนดตารางอัตราความสำเร็จ
        // แต่ละ itemKey (เช่น "Weapon_1") มี sub-object "normal" และ "cash"
        // ภายใน "normal" หรือ "cash" จะมีอัตราสำเร็จสำหรับวัสดุแต่ละชนิด
        const SUCCESS_RATES = {
            "Armor_1": {
                "normal": { // อัตราปกติ (จากภาพ)
                    "Elunium": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 80, 5: 60, 6: 60, 7: 40, 8: 40, 9: 20, 10: 20 },
                    "Carnium": { 11: 16, 12: 16, 13: 16, 14: 15, 15: 15, 16: 14, 17: 14, 18: 14, 19: 10 },
                    // Enriched Elunium, HD Elunium, HD Carnium ไม่มี rate_group "normal" ในตารางที่ให้มา
                    // ใช้เรทเดียวกับ Elunium/Carnium ใน normal mode ถ้าไม่มีข้อมูลเฉพาะ (ตามหลักการเกมส่วนใหญ่)
                    "Enriched Elunium": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 80, 5: 60, 6: 60, 7: 40, 8: 40, 9: 20, 10: 20 }, // สมมติเรทเท่า Elunium
                    "HD Elunium": { 7: 40, 8: 40, 9: 20, 10: 20 }, // สมมติเรทเท่า Elunium ในช่วง 7-10
                    "HD Carnium": { 11: 16, 12: 16, 13: 16, 14: 15, 15: 15, 16: 14, 17: 14, 18: 14, 19: 10 }, // สมมติเรทเท่า Carnium
                },
                "cash": { // อัตรากิจกรรม (จากภาพ)
                    "Elunium": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 100, 5: 95, 6: 85, 7: 70, 8: 70, 9: 55, 10: 45 },
                    "Carnium": { 11: 35, 12: 35, 13: 30, 14: 30, 15: 30, 16: 20, 17: 20, 18: 20, 19: 10 },
                    "Enriched Elunium": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 100, 5: 95, 6: 85, 7: 70, 8: 70, 9: 55, 10: 45 },
                    "HD Elunium": { 7: 70, 8: 70, 9: 55, 10: 45 }, // HD Elunium มีเรทตั้งแต่ +7 (อิงจากเรท Elunium cash)
                    "HD Carnium": { 11: 35, 12: 35, 13: 30, 14: 30, 15: 30, 16: 20, 17: 20, 18: 20, 19: 10 }, // HD Carnium (อิงจากเรท Carnium cash)
                }
            },
            "Armor_2": { // ไม่มีข้อมูลในภาพที่ให้มา ใช้เรทเดิม
                "normal": {
                    "Etherium": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 80, 5: 60, 6: 60, 7: 40, 8: 40, 9: 20, 10: 20 },
                    "Etel Carnium": { 11: 16, 12: 16, 13: 16, 14: 15, 15: 15, 16: 14, 17: 14, 18: 14, 19: 10 },
                    "Enriched Etherium": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 80, 5: 60, 6: 60, 7: 40, 8: 40, 9: 20, 10: 20 },
                    "HD Etherium": { 11: 16, 12: 16, 13: 16, 14: 15 },
                    "HD Etel Carnium": { 15: 14, 16: 14, 17: 14, 18: 14, 19: 10 },
                },
                "cash": {
                    "Etherium": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 100, 5: 95, 6: 85, 7: 70, 8: 70, 9: 55, 10: 45 },
                    "Etel Carnium": { 11: 35, 12: 35, 13: 30, 14: 30, 15: 30, 16: 20, 17: 20, 18: 20, 19: 10 },
                    "Enriched Etherium": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 100, 5: 95, 6: 85, 7: 70, 8: 70, 9: 55, 10: 45 },
                    "HD Etherium": { 11: 35, 12: 35, 13: 30, 14: 30 },
                    "HD Etel Carnium": { 15: 30, 16: 20, 17: 20, 18: 20, 19: 10 },
                }
            },
            "Weapon_1": {
                "normal": { // อัตราปกติ (จากภาพ)
                    "Phracon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 80, 5: 60, 6: 60, 7: 40, 8: 40, 9: 20, 10: 20 },
                    "Bradium": { 11: 16, 12: 16, 13: 16, 14: 15, 15: 15, 16: 14, 17: 14, 18: 14, 19: 10 },
                    // Enriched Phracon ถูกลบออก
                },
                "cash": { // อัตรากิจกรรม (จากภาพ)
                    "Phracon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 100, 5: 95, 6: 85, 7: 70, 8: 70, 9: 55, 10: 45 },
                    "Bradium": { 11: 35, 12: 35, 13: 30, 14: 30, 15: 30, 16: 20, 17: 20, 18: 20, 19: 10 },
                    // Enriched Phracon ถูกลบออก
                }
            },
            "Weapon_2": {
                "normal": { // อัตราปกติ (จากภาพ)
                    "Emveretarcon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 80, 5: 60, 6: 60, 7: 40, 8: 40, 9: 20, 10: 20 },
                    "Bradium": { 11: 16, 12: 16, 13: 16, 14: 15, 15: 15, 16: 14, 17: 14, 18: 14, 19: 10 },
                    // Enriched Emveretarcon ถูกลบออก
                },
                "cash": { // อัตรากิจกรรม (จากภาพ)
                    "Emveretarcon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 100, 5: 95, 6: 85, 7: 70, 8: 70, 9: 55, 10: 45 },
                    "Bradium": { 11: 35, 12: 35, 13: 30, 14: 30, 15: 30, 16: 20, 17: 20, 18: 20, 19: 10 },
                    // Enriched Emveretarcon ถูกลบออก
                }
            },
            "Weapon_3": {
                "normal": { // อัตราปกติ (จากภาพ)
                    "Oridecon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 80, 5: 60, 6: 60, 7: 40, 8: 40, 9: 20, 10: 20 },
                    "Bradium": { 11: 16, 12: 16, 13: 16, 14: 15, 15: 15, 16: 14, 17: 14, 18: 14, 19: 10 },
                    "Enriched Oridecon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 80, 5: 60, 6: 60, 7: 40, 8: 40, 9: 20, 10: 20 }, // สมมติเรทเท่า Oridecon
                    "HD Oridecon": { 7: 40, 8: 40, 9: 20, 10: 20 }, // สมมติเรทเท่า Oridecon ในช่วง 7-10
                },
                "cash": { // อัตรากิจกรรม (จากภาพ)
                    "Oridecon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 100, 5: 95, 6: 85, 7: 70, 8: 70, 9: 55, 10: 45 },
                    "Bradium": { 11: 35, 12: 35, 13: 30, 14: 30, 15: 30, 16: 20, 17: 20, 18: 20, 19: 10 },
                    "Enriched Oridecon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 100, 5: 95, 6: 85, 7: 70, 8: 70, 9: 55, 10: 45 },
                    "HD Oridecon": { 7: 70, 8: 70, 9: 55, 10: 45 }, // HD Oridecon 7-10 (อิงจากเรท Oridecon cash)
                }
            },
            "Weapon_4": { // Same as Weapon_3
                "normal": { // อัตราปกติ (จากภาพ)
                    "Oridecon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 80, 5: 60, 6: 60, 7: 40, 8: 40, 9: 20, 10: 20 },
                    "Bradium": { 11: 16, 12: 16, 13: 16, 14: 15, 15: 15, 16: 14, 17: 14, 18: 14, 19: 10 },
                    "Enriched Oridecon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 80, 5: 60, 6: 60, 7: 40, 8: 40, 9: 20, 10: 20 },
                    "HD Oridecon": { 7: 40, 8: 40, 9: 20, 10: 20 },
                },
                "cash": { // อัตรากิจกรรม (จากภาพ)
                    "Oridecon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 100, 5: 95, 6: 85, 7: 70, 8: 70, 9: 55, 10: 45 },
                    "Bradium": { 11: 35, 12: 35, 13: 30, 14: 30, 15: 30, 16: 20, 17: 20, 18: 20, 19: 10 },
                    "Enriched Oridecon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 100, 5: 95, 6: 85, 7: 70, 8: 70, 9: 55, 10: 45 },
                    "HD Oridecon": { 7: 70, 8: 70, 9: 55, 10: 45 },
                }
            },
            "Weapon_5": { // ไม่มีข้อมูลในภาพที่ให้มา ใช้เรทเดิม
                "normal": {
                    "Etherdeocon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 80, 5: 60, 6: 60, 7: 40, 8: 40, 9: 20, 10: 20 },
                    "Etel Bradium": { 11: 16, 12: 16, 13: 16, 14: 15, 15: 15, 16: 14, 17: 14, 18: 14, 19: 10 },
                    "Enriched Etherdeocon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 80, 5: 60, 6: 60, 7: 40, 8: 40, 9: 20, 10: 20 },
                    "HD Etherdeocon": { 11: 16, 12: 16, 13: 16, 14: 15 },
                    "HD Etel Bradium": { 11: 16, 12: 16, 13: 16, 14: 15 },
                },
                "cash": {
                    "Etherdeocon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 95, 5: 85, 6: 85, 7: 70, 8: 70, 9: 55, 10: 45 },
                    "Etel Bradium": { 11: 35, 12: 35, 13: 30, 14: 30, 15: 30, 16: 20, 17: 20, 18: 20, 19: 10 },
                    "Enriched Etherdeocon": { 0: 100, 1: 100, 2: 100, 3: 100, 4: 95, 5: 85, 6: 85, 7: 70, 8: 70, 9: 55, 10: 45 },
                    "HD Etherdeocon": { 11: 35, 12: 35, 13: 30, 14: 30 },
                    "HD Etel Bradium": { 11: 35, 12: 35, 13: 30, 14: 30 },
                }
            }
        };

        // 2. กำหนดกฎการตีบวกและวัสดุที่ใช้
        // ทุกวัสดุจะถูกรวมอยู่ในลิสต์เดียวกัน แต่จะระบุช่วงที่สามารถใช้ได้และ fail_effect
        const REFINE_MATERIALS = {
            "Weapon": {
                1: [
                    { material_id: "Phracon", name: "Phracon", fail_effect: "destroy", range: [0, 10] },
                    { material_id: "Bradium", name: "Bradium", fail_effect: "destroy", range: [11, 19] },
                    // Enriched Phracon ถูกลบออก
                ],
                2: [
                    { material_id: "Emveretarcon", name: "Emveretarcon", fail_effect: "destroy", range: [0, 10] },
                    { material_id: "Bradium", name: "Bradium", fail_effect: "destroy", range: [11, 19] },
                    // Enriched Emveretarcon ถูกลบออก
                ],
                3: [
                    { material_id: "Oridecon", name: "Oridecon", fail_effect: "destroy", range: [0, 10] },
                    { material_id: "Bradium", name: "Bradium", fail_effect: "destroy", range: [11, 19] },
                    { material_id: "Enriched Oridecon", name: "Enriched Oridecon", fail_effect: "destroy", range: [0, 10] },
                    { material_id: "HD Oridecon", name: "HD Oridecon", fail_effect: "decrease_1", range: [7, 10] },
                ],
                4: [ // Same as Lv.3
                    { material_id: "Oridecon", name: "Oridecon", fail_effect: "destroy", range: [0, 10] },
                    { material_id: "Bradium", name: "Bradium", fail_effect: "destroy", range: [11, 19] },
                    { material_id: "Enriched Oridecon", name: "Enriched Oridecon", fail_effect: "destroy", range: [0, 10] },
                    { material_id: "HD Oridecon", name: "HD Oridecon", fail_effect: "decrease_1", range: [7, 10] },
                ],
                5: [
                    { material_id: "Etherdeocon", name: "Etherdeocon", fail_effect: "decrease_3", range: [0, 10] },
                    { material_id: "Etel Bradium", name: "Etel Bradium", fail_effect: "destroy", range: [11, 19] },
                    { material_id: "Enriched Etherdeocon", name: "Enriched Etherdeocon", fail_effect: "decrease_1", range: [0, 10] },
                    { material_id: "HD Etherdeocon", name: "HD Etherdeocon", fail_effect: "destroy", range: [11, 14] },
                    { material_id: "HD Etel Bradium", name: "HD Etel Bradium", fail_effect: "destroy", range: [11, 14] },
                ]
            },
            "Armor": {
                1: [
                    { material_id: "Elunium", name: "Elunium", fail_effect: "destroy", range: [0, 10] },
                    { material_id: "Carnium", name: "Carnium", fail_effect: "destroy", range: [11, 19] },
                    { material_id: "Enriched Elunium", name: "Enriched Elunium", fail_effect: "destroy", range: [0, 10] },
                    { material_id: "HD Elunium", name: "HD Elunium", fail_effect: "decrease_1", range: [7, 10] },
                    { material_id: "HD Carnium", name: "HD Carnium", fail_effect: "destroy", range: [11, 19] },
                ],
                2: [
                    { material_id: "Etherium", name: "Etherium", fail_effect: "decrease_3", range: [0, 10] },
                    { material_id: "Etel Carnium", name: "Etel Carnium", fail_effect: "destroy", range: [11, 19] },
                    { material_id: "Enriched Etherium", name: "Enriched Etherium", fail_effect: "decrease_1", range: [0, 10] },
                    { material_id: "HD Etherium", name: "HD Etherium", fail_effect: "destroy", range: [11, 14] },
                    { material_id: "HD Etel Carnium", name: "HD Etel Carnium", fail_effect: "destroy", range: [15, 19] },
                ]
            }
        };

        // 3. Blacksmith Blessing (BSB) Costs
        const BSB_COSTS = {
            "normal": { // ช่วงไม่มีกิจกรรม
                7: 1, 
                8: 2, 
                9: 4, 
                10: 7,
                11: 11,
                12: 16,
                13: 22,
            },
            "cash": { // ช่วงกิจกรรม
                7: 1,
                8: 2,
                9: 3, 
                10: 4,
                11: 7, 
                12: 11,
                13: 16,
            }
        };

        // UI Elements
        const itemTypeSelect = document.getElementById('itemType');
        const itemLevelInput = document.getElementById('itemLevel');
        const refineMaterialSelect = document.getElementById('refineMaterial');
        const useBsbCheckbox = document.getElementById('useBsb');
        const eventRateCheckbox = document.getElementById('eventRateCheckbox'); // Checkbox for event rate
        const refineOnceBtn = document.getElementById('refineOnceBtn');
        const resetItemBtn = document.getElementById('resetItemBtn');
        const resultsLog = document.getElementById('resultsLog');
        const currentRefineLevelDisplay = document.getElementById('currentRefineLevelDisplay');
        const itemStatusDisplay = document.getElementById('itemStatusDisplay');
        const totalAttemptsSpan = document.getElementById('totalAttempts');
        const materialSummaryList = document.getElementById('materialSummary');
        const currentStatusContainer = document.querySelector('.current-status');
        const currentSuccessRateDisplay = document.getElementById('currentSuccessRateDisplay');

        let currentRefineLevel = 0;
        let itemBroken = false;
        let totalAttempts = 0;
        let materialsUsed = {}; // Dictionary to store material counts

        // Helper function for random number (similar to Python's random.random())
        const random = {
            random: function() {
                return Math.random();
            }
        };

        // --- Functions to manage UI and game state ---

        function logResult(message, type = "") {
            const p = document.createElement('p');
            p.textContent = message;
            p.classList.add('log-item');
            if (type) {
                p.classList.add(`log-${type}`);
            }
            resultsLog.prepend(p); // Add to top for easier viewing of latest
            // Keep only last 100 logs to prevent performance issues
            while (resultsLog.children.length > 100) {
                resultsLog.removeChild(resultsLog.lastChild);
            }
        }

        function updateMaterialSummary() {
            materialSummaryList.innerHTML = '';
            // Sort materials by name for consistent display
            const sortedMaterials = Object.keys(materialsUsed).sort();
            for (const material of sortedMaterials) {
                if (materialsUsed[material] > 0) {
                    const li = document.createElement('li');
                    li.textContent = `${material}: ${materialsUsed[material]} ชิ้น`;
                    materialSummaryList.appendChild(li);
                }
            }
        }

        function getCalculatedSuccessRate() {
            const itemType = itemTypeSelect.value;
            const itemLevel = parseInt(itemLevelInput.value);
            const selectedMaterialValue = refineMaterialSelect.value;
            const useEventRate = eventRateCheckbox.checked; // Get state of event rate checkbox

            if (!selectedMaterialValue) {
                return "N/A"; // No material selected
            }

            // materialDisplayName is now stored directly as the value
            const [materialId, failEffectRaw, materialDisplayName, materialRangeStart, materialRangeEnd] = selectedMaterialValue.split('|');
            
            const refineLevelToAttempt = currentRefineLevel;
            const itemKey = `${itemType}_${itemLevel}`;
            
            // Determine which rate set to use based on eventRateCheckbox
            const rateSet = useEventRate ? "cash" : "normal";
            
            // Get the success rate for the specific material and refine level from the chosen rateSet
            const ratesForMaterial = SUCCESS_RATES[itemKey]?.[rateSet]?.[materialId];
            const successRate = ratesForMaterial ? ratesForMaterial[refineLevelToAttempt] : undefined;
            
            return successRate !== undefined ? `${successRate}%` : "N/A";
        }

        function updateCurrentItemStatus() {
            currentRefineLevelDisplay.textContent = `+${currentRefineLevel}`;
            if (itemBroken) {
                itemStatusDisplay.textContent = 'เสียหาย!';
                currentStatusContainer.classList.add('broken');
                refineOnceBtn.disabled = true; // Disable refine if broken
                refineMaterialSelect.disabled = true;
                useBsbCheckbox.disabled = true;
                eventRateCheckbox.disabled = true; // Disable event rate checkbox if broken
            } else {
                itemStatusDisplay.textContent = 'ปกติ';
                currentStatusContainer.classList.remove('broken');
                refineOnceBtn.disabled = false;
                refineMaterialSelect.disabled = false;
                // --- Start: BSB Checkbox specific logic ---
                // Disable BSB checkbox if currentRefineLevel is less than 7
                useBsbCheckbox.disabled = (currentRefineLevel < 7);
                // If BSB checkbox is disabled, uncheck it to prevent accidental use
                if (useBsbCheckbox.disabled) {
                    useBsbCheckbox.checked = false;
                }
                // --- End: BSB Checkbox specific logic ---
                eventRateCheckbox.disabled = false; // Enable event rate checkbox if not broken
            }
            totalAttemptsSpan.textContent = totalAttempts;
            updateMaterialSummary();
            updateMaterialOptions(true); // Call with true to try and preserve selection
            currentSuccessRateDisplay.textContent = getCalculatedSuccessRate(); // Update success rate display
        }

        function updateMaterialOptions(preserveSelection = false) {
            const itemType = itemTypeSelect.value;
            const itemLevel = parseInt(itemLevelInput.value);
            const useEventRate = eventRateCheckbox.checked;
            const itemKey = `${itemType}_${itemLevel}`;
            
            const availableMaterials = REFINE_MATERIALS[itemType] ? REFINE_MATERIALS[itemType][itemLevel] : [];
            const previousSelection = refineMaterialSelect.value; // Store previous selection
            
            refineMaterialSelect.innerHTML = ''; // Clear previous options

            if (itemBroken) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'ไอเทมเสียหาย (รีเซ็ตเพื่อเริ่มใหม่)';
                refineMaterialSelect.appendChild(option);
                refineOnceBtn.disabled = true;
                currentSuccessRateDisplay.textContent = "N/A";
                return;
            }

            if (availableMaterials.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'ไม่มีวัสดุให้เลือกสำหรับระดับนี้';
                refineMaterialSelect.appendChild(option);
                refineOnceBtn.disabled = true;
                currentSuccessRateDisplay.textContent = "N/A";
                return;
            }
            
            refineOnceBtn.disabled = false;

            let hasValidMaterial = false;
            let foundPreviousSelection = false;
            let firstValidMaterialValue = '';

            // Populate select with available materials that are valid for current refine level
            availableMaterials.forEach(material => {
                const materialId = material.material_id;
                const materialDisplayName = material.name;
                const failEffect = material.fail_effect;
                const rangeStart = material.range[0];
                const rangeEnd = material.range[1];

                // Check if the current refine level is within the material's valid range
                if (currentRefineLevel >= rangeStart && currentRefineLevel <= rangeEnd) {
                    const rateSet = useEventRate ? "cash" : "normal";
                    const successRate = SUCCESS_RATES[itemKey]?.[rateSet]?.[materialId]?.[currentRefineLevel];
                    
                    if (successRate !== undefined) { // Only show materials with a defined rate for current level and selected rateSet
                        const option = document.createElement('option');
                        // Store material_id, fail_effect, name, range_start, range_end in value for easy retrieval
                        const optionValue = `${materialId}|${failEffect}|${materialDisplayName}|${rangeStart}|${rangeEnd}`;
                        option.value = optionValue;
                        option.textContent = `${materialDisplayName} (เรท ${successRate}%)`; // Display rate in option
                        refineMaterialSelect.appendChild(option);
                        hasValidMaterial = true;

                        if (preserveSelection && optionValue === previousSelection) {
                            foundPreviousSelection = true;
                            option.selected = true;
                        }

                        if (!firstValidMaterialValue) {
                            firstValidMaterialValue = optionValue;
                        }
                    }
                }
            });

            // If no valid materials for current level and rate set, disable button and clear rate
            if (!hasValidMaterial) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'ไม่มีวัสดุที่รองรับระดับนี้';
                refineMaterialSelect.appendChild(option);
                refineOnceBtn.disabled = true;
                currentSuccessRateDisplay.textContent = "N/A";
            } else {
                if (preserveSelection && foundPreviousSelection) {
                    // Already selected
                } else if (firstValidMaterialValue) {
                    refineMaterialSelect.value = firstValidMaterialValue; // Select the first valid option
                }
            }
            currentSuccessRateDisplay.textContent = getCalculatedSuccessRate();
        }

        function refineItem() {
            if (itemBroken) {
                logResult("ไอเทมเสียหายแล้ว! กรุณารีเซ็ตไอเทมเพื่อเริ่มใหม่.", "fail");
                return;
            }

            const itemType = itemTypeSelect.value;
            const itemLevel = parseInt(itemLevelInput.value);
            const selectedMaterialValue = refineMaterialSelect.value;
            const useBsb = useBsbCheckbox.checked;
            const useEventRate = eventRateCheckbox.checked; // Get state of event rate checkbox

            if (!selectedMaterialValue) {
                logResult("กรุณาเลือกวัสดุสำหรับตีบวก.", "fail");
                return;
            }

            const [materialId, failEffectRaw, materialDisplayName, materialRangeStart, materialRangeEnd] = selectedMaterialValue.split('|');
            
            const refineLevelToAttempt = currentRefineLevel;
            const itemKey = `${itemType}_${itemLevel}`;
            
            // Determine which rate set to use based on eventRateCheckbox
            const rateSet = useEventRate ? "cash" : "normal";
            const successRate = SUCCESS_RATES[itemKey]?.[rateSet]?.[materialId]?.[refineLevelToAttempt];

            if (successRate === undefined) {
                logResult(`Error: ไม่พบอัตราสำเร็จสำหรับ ${materialDisplayName} ที่ระดับ +${refineLevelToAttempt} ในเรท ${rateSet}. โปรดตรวจสอบข้อมูล.`, "fail");
                return;
            }
            
            // Check if selected material is valid for the current refine level before proceeding
            if (refineLevelToAttempt < parseInt(materialRangeStart) || refineLevelToAttempt > parseInt(materialRangeEnd)) {
                logResult(`Error: วัสดุ ${materialDisplayName} ไม่สามารถใช้ตีบวกที่ระดับ +${refineLevelToAttempt} ได้. ช่วงที่รองรับคือ +${materialRangeStart} ถึง +${materialRangeEnd}.`, "fail");
                return;
            }

            // Track material usage
            materialsUsed[materialDisplayName] = (materialsUsed[materialDisplayName] || 0) + 1;
            totalAttempts++;

            let bsbUsed = 0;
            // Use selected rate group (normal/cash) to get BSB cost
            const bsbCost = BSB_COSTS[rateSet] ? BSB_COSTS[rateSet][refineLevelToAttempt] : 0;

            if (useBsb && bsbCost > 0) {
                bsbUsed = bsbCost;
                materialsUsed["Blacksmith Blessing"] = (materialsUsed["Blacksmith Blessing"] || 0) + bsbUsed;
                logResult(`ใช้ Blacksmith Blessing ${bsbUsed} ชิ้น`);
            } else if (useBsb && bsbCost === 0 && refineLevelToAttempt >=7 && refineLevelToAttempt <= 13) {
                logResult(`Warning: Blacksmith Blessing ไม่รองรับระดับ +${refineLevelToAttempt} ด้วยเรท ${rateSet} หรือไม่มีข้อมูล.`, "fail");
            }

            const rand = random.random() * 100; // Generate a random number between 0 and 99.99...

            logResult(`พยายามตีบวก ${itemType} Lv.${itemLevel} จาก +${refineLevelToAttempt} เป็น +${refineLevelToAttempt + 1} (ใช้ ${materialDisplayName}, เรท: ${rateSet === 'cash' ? 'กิจกรรม' : 'ปกติ'}) - โอกาสสำเร็จ: ${successRate}%`);

            if (rand < successRate) {
                currentRefineLevel++;
                logResult(`สำเร็จ! ไอเทมเป็น +${currentRefineLevel}`, "success");
            } else {
                logResult(`ล้มเหลว!`, "fail");
                // BSB protection logic
                if (useBsb && bsbCost > 0 && refineLevelToAttempt >= 7 && refineLevelToAttempt <= 13) {
                    logResult(`Blacksmith Blessing ป้องกันไอเทมไว้ได้! ไอเทมคงอยู่ที่ +${currentRefineLevel}`, "log-item");
                } else {
                    // Apply normal failure effect based on failEffectRaw
                    if (failEffectRaw === "destroy") {
                        logResult(`ไอเทมเสียหาย!`, "destroy");
                        itemBroken = true; // Mark item as broken
                    } else if (failEffectRaw === "decrease_1") {
                        currentRefineLevel = Math.max(0, currentRefineLevel - 1);
                        logResult(`ระดับตีบวกลดลง 1 ขั้น เป็น +${currentRefineLevel}`, "decrease");
                    } else if (failEffectRaw === "decrease_3") {
                        currentRefineLevel = Math.max(0, currentRefineLevel - 3);
                        logResult(`ระดับตีบวกลดลง 3 ขั้น เป็น +${currentRefineLevel}`, "decrease");
                    } else if (failEffectRaw === "none") {
                        logResult(`ไม่มีผลกระทบจากการล้มเหลว (ไอเทมคงอยู่ที่ +${currentRefineLevel})`, "log-item");
                    }
                }
            }
            updateCurrentItemStatus(); // Update UI after refine attempt
        }

        function resetItem() {
            currentRefineLevel = 0;
            itemBroken = false;
            totalAttempts = 0;
            materialsUsed = {};
            resultsLog.innerHTML = ''; // Clear log
            logResult("รีเซ็ตไอเทมเรียบร้อยแล้ว! เริ่มต้นใหม่ที่ +0", "log-item");
            updateCurrentItemStatus(); // Update UI
        }

        // Event Listeners
        refineOnceBtn.addEventListener('click', refineItem);
        resetItemBtn.addEventListener('click', resetItem);
        itemTypeSelect.addEventListener('change', () => {
            currentRefineLevel = 0; // Reset refine level when item type changes
            itemBroken = false; // Reset broken status
            updateCurrentItemStatus();
        });
        itemLevelInput.addEventListener('change', () => {
            currentRefineLevel = 0; // Reset refine level when item level changes
            itemBroken = false; // Reset broken status
            updateCurrentItemStatus();
        });
        refineMaterialSelect.addEventListener('change', () => {
            currentSuccessRateDisplay.textContent = getCalculatedSuccessRate(); // Update success rate display
        });
        eventRateCheckbox.addEventListener('change', () => {
            updateMaterialOptions(); // Re-populate materials to reflect rate changes
            updateCurrentItemStatus(); // Update BSB disabled state
        });
        
        // Initial setup
        updateCurrentItemStatus();
    </script>
</body>
</html>